<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tótem - Asistencia Facial</title>
    <style>
      body { margin:0; font-family: system-ui, sans-serif; background:#111; color:#eee; }
      header { padding:12px 16px; background:#000; position:sticky; top:0; }
      main { padding:16px; }
      .btn { padding: 10px 14px; margin-right: 8px; border: 0; border-radius: 6px; cursor:pointer; }
      .btn.ingreso { background:#0a7; color:#fff; }
      .btn.egreso { background:#c50; color:#fff; }
      .card { background:#1b1b1b; border:1px solid #333; border-radius:8px; padding:16px; margin:16px 0; text-align:center; position:relative }
      #overlay { position:absolute; left:50%; transform:translateX(-50%); top:12px; padding:10px 16px; background:rgba(10,10,10,.7); border:1px solid #444; border-radius:10px; min-width:240px; text-align:center; font-weight:600; font-size:18px; box-shadow:0 6px 20px rgba(0,0,0,.35) }
      .muted { display:none }
    </style>
  </head>
  <body>
    <header>
      <strong>Tótem</strong>
      <!-- Backend info oculto por solicitud -->
    </header>
    <main>
      <div class="card">
        <video id="cam" autoplay playsinline muted style="width:720px; max-width:100%; background:#000; border-radius:8px; border:1px solid #333; display:block; margin:0 auto 16px"></video>
        <div id="overlay"></div>
        <div>
          <button class="btn ingreso" id="btnIn">Ingreso</button>
          <button class="btn egreso" id="btnEg">Egreso</button>
        </div>
        <p class="muted">La cámara se procesa localmente. No se envían imágenes al backend.</p>
      </div>
    </main>

    <script>
      const API_BASE = (window.CONFIG && window.CONFIG.API_BASE) || 'http://localhost:8000';
      const API_KEY = (window.CONFIG && window.CONFIG.TOTEM_API_KEY) || 'dev-totem-key';
      (function(){ const el = document.getElementById('apiBase'); if (el) el.textContent = API_BASE; })();

      const $ = (id) => document.getElementById(id);
      const overlay = $('overlay');
      const CONFIG = { MODEL_URL: '/model/face_embedder.onnx', INTERVAL_MS: 600, THRESH: 0.38, WINDOW: 5, MIN_HITS: 3 };
      let ortSession = null; let gallery = []; let ring = []; let currentStable = { id:null, distance: Infinity };

      function setOverlay(text, ok=false){ overlay.textContent = text; overlay.style.color = ok ? '#0a7' : '#eee'; }
      const warn=(...a)=>console.warn('[totem]',...a);

      async function startCamera(){ try{ const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false }); $('cam').srcObject = s; }catch(e){ warn('Cam:', e.message); } }
      async function loadModel(){ try{ if(!window.ort) throw new Error('Falta onnxruntime-web'); const head=await fetch(CONFIG.MODEL_URL,{method:'HEAD'}); if(!head.ok) throw new Error('Modelo no encontrado'); ort.env.wasm.numThreads=1; ortSession=await ort.InferenceSession.create(CONFIG.MODEL_URL,{executionProviders:['wasm']}); }catch(e){ warn('Modelo:', e.message); } }
      async function loadGallery(){ try{ const res=await fetch(`${API_BASE}/employees/gallery`,{headers:{'x-api-key':API_KEY}}); const data=await res.json(); if(!res.ok) throw new Error(data.detail||res.statusText); gallery=(data||[]).filter(x=>x.embedding&&x.embedding.length).map(x=>({id:x.id, emb:l2norm(new Float32Array(x.embedding))})); }catch(e){ warn('Galería:', e.message); } }

      function l2norm(v){ let s=0; for(let i=0;i<v.length;i++) s+=v[i]*v[i]; s=Math.sqrt(s)||1; for(let i=0;i<v.length;i++) v[i]/=s; return v; }
      function preprocess(video){ const c=document.createElement('canvas'); c.width=112; c.height=112; const ctx=c.getContext('2d'); const vw=video.videoWidth,vh=video.videoHeight,side=Math.min(vw,vh),sx=Math.floor((vw-side)/2),sy=Math.floor((vh-side)/2); ctx.drawImage(video,sx,sy,side,side,0,0,112,112); const img=ctx.getImageData(0,0,112,112).data; const out=new Float32Array(1*3*112*112); let r=0,g=112*112,b=2*112*112; for(let i=0,p=0;i<img.length;i+=4,p++){ out[r++]=(img[i]/127.5)-1; out[g++]=(img[i+1]/127.5)-1; out[b++]=(img[i+2]/127.5)-1; } return out; }
      function cosineDistance(a,b){ let dot=0,na=0,nb=0; for(let i=0;i<a.length;i++){ const x=a[i],y=b[i]; dot+=x*y; na+=x*x; nb+=y*y; } const denom=Math.sqrt(na)*Math.sqrt(nb)||1; return 1-(dot/denom); }

      async function embedFrame(){ if(!ortSession) return null; const input=preprocess($('cam')); const feeds={}; const name=ortSession.inputNames?ortSession.inputNames[0]:Object.keys(ortSession.inputNames||{})[0]; feeds[name]=new ort.Tensor('float32',input,[1,3,112,112]); const out=await ortSession.run(feeds); const first=out[ortSession.outputNames?ortSession.outputNames[0]:Object.keys(out)[0]]; return l2norm(new Float32Array(first.data)); }

      async function loop(){ try{ const q=await embedFrame(); if(!q||!gallery.length){ setOverlay('Preparando…'); return; } let bestId=null,bestDist=Infinity; for(const item of gallery){ const d=cosineDistance(q,item.emb); if(d<bestDist){ bestDist=d; bestId=item.id; } } const accepted=bestDist<=CONFIG.THRESH?bestId:null; ring.push(accepted); if(ring.length>CONFIG.WINDOW) ring.shift(); const hits=ring.filter(x=>x!==null&&x===bestId).length; if(accepted&&hits>=CONFIG.MIN_HITS){ currentStable.id=bestId; currentStable.distance=bestDist; setOverlay(`Empleado #${bestId}` ,true); } else { currentStable.id=null; currentStable.distance=Infinity; setOverlay('Desconocido'); } } catch(e){ warn('Loop:', e.message); }
      }

      async function warmupBackend(retries=3){
        try{
          setOverlay('Iniciando backend...');
          const ctrl = new AbortController();
          const t = setTimeout(()=>ctrl.abort(), 15000);
          const res = await fetch(`${API_BASE}/healthz`, { method:'GET', cache:'no-store', signal: ctrl.signal });
          clearTimeout(t);
          if(!res.ok) throw new Error('Backend no disponible');
        }catch(e){
          if(retries>0){
            await new Promise(r=>setTimeout(r, 5000));
            return warmupBackend(retries-1);
          }
          throw e;
        }
      }

      async function init(){
        try{
          await startCamera();
          await loadModel();
          await warmupBackend();
          await loadGallery();
          setInterval(loop, CONFIG.INTERVAL_MS);
        }catch(e){
          setOverlay(`Error: ${e.message||e}`, false);
        }
      }
      async function enviarAsistencia(tipo){ try{ if(!currentStable.id) throw new Error('Sin match estable'); const res=await fetch(`${API_BASE}/asistencia`,{method:'POST',headers:{'x-api-key':API_KEY,'Content-Type':'application/json'},body:JSON.stringify({id_empleado:currentStable.id,tipo,distancia:currentStable.distance||0,origen:'totem'})}); const data=await res.json(); if(!res.ok) throw new Error(data.detail||res.statusText); setOverlay(`${tipo} OK`,true);}catch(e){ setOverlay(e.message,false);} }

      $('btnIn').onclick=()=>enviarAsistencia('ingreso'); $('btnEg').onclick=()=>enviarAsistencia('egreso');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script> if (navigator.mediaDevices?.getUserMedia) { init(); } </script>
    <script>window.CONFIG = { API_BASE: 'https://administracion-pyme-alimenticia.onrender.com', TOTEM_API_KEY: 'prod-totem-key-8d73c5c2f1a94d5e9b3a' };</script>
  </body>
  </html>
